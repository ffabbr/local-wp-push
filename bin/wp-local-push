#!/usr/bin/env bash
set -euo pipefail

APP_NAME="wp-local-push"
KEYCHAIN_SERVICE="wp-local-push"

CONFIG_DIR_DEFAULT="${XDG_CONFIG_HOME:-$HOME/.config}/wp-local-push"
CONFIG_FILE_DEFAULT="$CONFIG_DIR_DEFAULT/config"

usage() {
  cat <<'EOF'
wp-local-push

Usage:
  wp-local-push setup
  wp-local-push push [--delete] [--dry-run]
  wp-local-push doctor

Config:
  Stored at ~/.config/wp-local-push/config (or $XDG_CONFIG_HOME/wp-local-push/config)
EOF
}

die() {
  echo "$APP_NAME: $*" >&2
  exit 1
}

need_cmd() {
  command -v "$1" >/dev/null 2>&1 || die "Missing dependency: $1"
}

ensure_config_dir() {
  mkdir -p "$CONFIG_DIR_DEFAULT"
}

config_file() {
  echo "$CONFIG_FILE_DEFAULT"
}

load_config() {
  local f
  f="$(config_file)"
  if [[ ! -f "$f" ]]; then
    return 1
  fi

  set +u
  # shellcheck disable=SC1090
  source "$f"
  set -u

  [[ -n "${LOCAL_SITES_DIR:-}" ]] || return 1
  [[ -n "${FTP_HOST:-}" ]] || return 1
  [[ -n "${FTP_USERNAME:-}" ]] || return 1
  [[ -n "${LFTP_BOOKMARK:-}" ]] || return 1
  [[ -n "${REMOTE_WP_ROOT:-}" ]] || return 1
  return 0
}

prompt() {
  local label default value
  label="$1"
  default="${2:-}"

  if [[ -n "$default" ]]; then
    read -r -p "$label [$default]: " value
    echo "${value:-$default}"
  else
    read -r -p "$label: " value
    echo "$value"
  fi
}

prompt_secret() {
  local label value
  label="$1"
  read -r -s -p "$label: " value
  echo
  echo "$value"
}

keychain_get_password() {
  local host
  host="$1"
  security find-generic-password -a "$host" -s "$KEYCHAIN_SERVICE" -w 2>/dev/null || true
}

keychain_set_password() {
  local host password
  host="$1"
  password="$2"
  security add-generic-password -a "$host" -s "$KEYCHAIN_SERVICE" -w "$password" -U >/dev/null 2>&1
}

keychain_has_password() {
  local host
  host="$1"
  security find-generic-password -a "$host" -s "$KEYCHAIN_SERVICE" >/dev/null 2>&1
}

lftp_exec() {
  local target cmd host username password
  target="$1"
  cmd="$2"
  host="$3"
  username="$4"

  password="$(keychain_get_password "$host")"
  [[ -n "$password" ]] || die "No keychain password found for '$host'. Run: $APP_NAME setup"

  lftp -u "$username,$password" "$target" -e "$cmd" >/dev/null 2>&1
}

lftp_exec_quiet() {
  local target cmd host username password
  target="$1"
  cmd="$2"
  host="$3"
  username="$4"

  password="$(keychain_get_password "$host")"
  [[ -n "$password" ]] || return 1

  lftp -u "$username,$password" "$target" -e "$cmd" >/dev/null 2>&1
}

lftp_test() {
  local target host username
  target="$1"
  host="$2"
  username="$3"
  lftp_exec_quiet "$target" "pwd; quit" "$host" "$username"
}

choose_remote_root() {
  local bookmark selection
  bookmark="$1"

  if command -v fzf >/dev/null 2>&1; then
    selection=$(lftp "$bookmark" -e "cls -1; quit" 2>/dev/null | awk 'NF' | { printf "/\n"; cat; } | fzf --prompt="Select remote sites root (choose / for server root) > " || true)
    if [[ -n "${selection:-}" ]]; then
      if [[ "$selection" == "/" ]]; then
        echo "/"
      else
        echo "/$selection"
      fi
      return 0
    fi
  fi

  echo "$(prompt "Remote sites root path (absolute, e.g. /public_html or /)" "/public_html")"
}

normalize_remote_root() {
  local path
  path="$1"
  if [[ "$path" != "/" ]]; then
    path="${path%/}"
  fi
  echo "$path"
}

cmd_setup() {
  need_cmd lftp
  need_cmd security

  if ! command -v fzf >/dev/null 2>&1; then
    echo "$APP_NAME: fzf is not installed."
    echo "$APP_NAME: Install it (macOS): brew install fzf"
    echo "$APP_NAME: Setup can continue, but interactive selection will be limited."
  fi

  ensure_config_dir

  local config
  config="$(config_file)"

  if [[ -f "$config" ]]; then
    local overwrite
    overwrite=$(prompt "Config already exists at $config. Overwrite? (y/N)" "N")
    [[ "$overwrite" == "y" || "$overwrite" == "Y" ]] || exit 0
  fi

  local local_sites_dir host bookmark username password remote_wp_root
  local_sites_dir=$(prompt "Local sites folder" "$HOME/Local Sites")
  host=$(prompt "FTP host (e.g. myserver.com)" "")
  bookmark=$(prompt "lftp bookmark name" "mywp")

  username=$(prompt "FTP username" "")
  password=$(prompt_secret "FTP password (stored in macOS Keychain)")

  [[ -n "$host" ]] || die "Host is required"
  [[ -n "$bookmark" ]] || die "Bookmark is required"
  [[ -n "$username" ]] || die "Username is required"
  [[ -n "$password" ]] || die "Password is required"

  if keychain_has_password "$host"; then
    local overwrite
    overwrite=$(prompt "Keychain already has credentials for '$host'. Overwrite? (y/N)" "N")
    [[ "$overwrite" == "y" || "$overwrite" == "Y" ]] || die "Refusing to overwrite Keychain entry."
  fi

  keychain_set_password "$host" "$password"

  if lftp_exec_quiet "$host" "bookmark add $bookmark; quit" "$host" "$username"; then
    :
  else
    if lftp_test "$bookmark" "$host" "$username"; then
      echo "$APP_NAME: using existing lftp bookmark '$bookmark'"
    else
      die "Failed to create or use lftp bookmark '$bookmark'"
    fi
  fi

  remote_wp_root=$(choose_remote_root "$bookmark")

  {
    echo "LOCAL_SITES_DIR=\"$local_sites_dir\""
    echo "FTP_HOST=\"$host\""
    echo "FTP_USERNAME=\"$username\""
    echo "LFTP_BOOKMARK=\"$bookmark\""
    echo "REMOTE_WP_ROOT=\"$remote_wp_root\""
  } >"$config"

  if lftp_test "$bookmark" "$host" "$username"; then
    echo "$APP_NAME: setup complete."
  else
    die "Could not connect using lftp bookmark '$bookmark'. Check Keychain entry and connectivity."
  fi
}

cmd_doctor() {
  local ok
  ok=1
  local has_security
  has_security=0

  if command -v lftp >/dev/null 2>&1; then
    echo "$APP_NAME: lftp ok"
  else
    echo "$APP_NAME: lftp missing (macOS: brew install lftp)"
    ok=0
  fi

  if command -v security >/dev/null 2>&1; then
    echo "$APP_NAME: security ok"
    has_security=1
  else
    echo "$APP_NAME: security missing (macOS Keychain CLI unavailable)"
    ok=0
  fi

  if command -v fzf >/dev/null 2>&1; then
    echo "$APP_NAME: fzf ok"
  else
    echo "$APP_NAME: fzf missing (macOS: brew install fzf)"
  fi

  if load_config; then
    echo "$APP_NAME: config ok ($(config_file))"
    if [[ "$has_security" -eq 1 ]]; then
      if keychain_has_password "$FTP_HOST"; then
        echo "$APP_NAME: keychain ok ($FTP_HOST)"
      else
        echo "$APP_NAME: keychain missing entry for $FTP_HOST"
        ok=0
      fi
    fi

    if lftp_test "$LFTP_BOOKMARK" "$FTP_HOST" "$FTP_USERNAME"; then
      echo "$APP_NAME: lftp connection ok ($LFTP_BOOKMARK)"
    else
      echo "$APP_NAME: lftp connection failed ($LFTP_BOOKMARK)"
      ok=0
    fi
  else
    echo "$APP_NAME: config missing/invalid. Run: wp-local-push setup"
    ok=0
  fi

  [[ "$ok" -eq 1 ]] || exit 1
}

cmd_push() {
  need_cmd lftp
  need_cmd fzf
  need_cmd security

  if ! load_config; then
    echo "$APP_NAME: no config found. Starting setup..."
    cmd_setup
    load_config || die "Setup did not produce a valid config"
  fi

  local mirror_flags
  mirror_flags=""

  while [[ $# -gt 0 ]]; do
    case "$1" in
      --delete)
        mirror_flags="$mirror_flags --delete"
        shift
        ;;
      --dry-run)
        mirror_flags="$mirror_flags --dry-run"
        shift
        ;;
      -h|--help)
        usage
        exit 0
        ;;
      *)
        die "Unknown argument: $1"
        ;;
    esac
  done

  [[ -d "$LOCAL_SITES_DIR" ]] || die "Local sites folder not found: $LOCAL_SITES_DIR"

  local site type local_base item local_path remote_path
  local remote_sites remote_site remote_root remote_site_root
  local password
  site=$(ls "$LOCAL_SITES_DIR" | fzf --prompt="Select Local Site > " || true)
  [[ -n "${site:-}" ]] || exit 1

  type=$(printf "themes\nplugins\n" | fzf --prompt="Sync Theme or Plugin > " || true)
  [[ -n "${type:-}" ]] || exit 1

  local_base="$LOCAL_SITES_DIR/$site/app/public/wp-content/$type"
  [[ -d "$local_base" ]] || die "Path not found: $local_base"

  item=$(ls "$local_base" | fzf --prompt="Select $type > " || true)
  [[ -n "${item:-}" ]] || exit 1

  local_path="$local_base/$item"
  [[ -d "$local_path" ]] || die "Local item path not found: $local_path"

  remote_root=$(normalize_remote_root "$REMOTE_WP_ROOT")

  password="$(keychain_get_password "$FTP_HOST")"
  [[ -n "$password" ]] || die "No keychain password found for '$FTP_HOST'. Run: $APP_NAME setup"

  remote_sites=$(lftp -u "$FTP_USERNAME,$password" "$LFTP_BOOKMARK" -e "cd '$remote_root'; cls -1 --dirs-only; quit" 2>/dev/null || true)
  remote_site=$(printf "%s\n" "$remote_sites" | awk 'NF' | fzf --prompt="Select Remote Site > " || true)
  [[ -n "${remote_site:-}" ]] || die "No remote site selected"

  if [[ "$remote_root" == "/" ]]; then
    remote_site_root="/$remote_site"
  else
    remote_site_root="$remote_root/$remote_site"
  fi

  remote_path="$remote_site_root/wp-content/$type/$item"

  echo
  echo "Local : $local_path"
  echo "Remote: $remote_path"

  local confirm
  confirm=$(prompt "Proceed? (y/N)" "N")
  [[ "$confirm" == "y" || "$confirm" == "Y" ]] || exit 0

  lftp -u "$FTP_USERNAME,$password" "$LFTP_BOOKMARK" -e "mirror -R$mirror_flags '$local_path' '$remote_path'; quit"

  echo "$APP_NAME: done."
}

main() {
  local cmd
  cmd="${1:-}"
  shift || true

  case "$cmd" in
    setup)
      cmd_setup "$@"
      ;;
    push)
      cmd_push "$@"
      ;;
    doctor)
      cmd_doctor "$@"
      ;;
    -h|--help|help|"")
      usage
      ;;
    *)
      die "Unknown command: $cmd"
      ;;
  esac
}

main "$@"
